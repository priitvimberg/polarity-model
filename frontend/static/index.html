<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polarity & Maturity Model</title>
  <!-- Bootstrap CSS for tooltips and modal -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Vis.js CSS -->
  <link href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" rel="stylesheet">
  <!-- Custom Styles -->
  <style>
    body.light { background-color: #ffffff; color: #000000; }
    body.dark { background-color: #1e1e1e; color: #ffffff; }
    .dark #network { background-color: #2c2c2c; }
    #network { width: 100%; height: 600px; border: 1px solid #ccc; }
    #spinner { display: none; text-align: center; padding: 20px; }
  </style>
</head>
<body class="light">
  <div class="container mt-4">
    <h1>Polarity & Maturity Model</h1>
    <!-- Theme Toggle -->
    <div class="form-check form-switch mb-3">
      <input class="form-check-input" type="checkbox" id="themeToggle" onchange="toggleTheme()">
      <label class="form-check-label" for="themeToggle">Dark Mode</label>
    </div>
    <!-- Form -->
    <form id="prompt-form">
      <div class="mb-3">
        <label for="example-select" class="form-label">Load Example</label>
        <select class="form-select" id="example-select" onchange="loadExample()">
          <option value="">Select an example</option>
          <option value="Stability vs. Change at maturity level 2">Stability vs. Change</option>
          <option value="Individual vs. Team at maturity level 4">Individual vs. Team</option>
          <option value="Centralization vs. Decentralization at maturity level 3">Centralization vs. Decentralization</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="prompt" class="form-label">Enter Polarity Prompt</label>
        <textarea class="form-control" id="prompt" rows="4" placeholder="e.g., Stability vs. Change at maturity level 3"
          data-bs-toggle="tooltip" data-bs-placement="top"
          title="Enter two poles (e.g., Stability vs. Change) and a maturity level (1-5, initial to optimizing)."></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Submit</button>
      <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
      <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#helpModal">Help</button>
      <button type="button" class="btn btn-primary" onclick="downloadGraph()">Download Graph as PNG</button>
    </form>
    <!-- Alert Placeholder -->
    <div id="alert-placeholder" class="mt-3"></div>
    <!-- Spinner -->
    <div id="spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <!-- Graph Container -->
    <div id="network"></div>
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="helpModalLabel">About Polarity & Maturity Model</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>This app visualizes polarities (ongoing dilemmas like 'Individual vs. Team') across maturity stages (1: Initial, 5: Optimizing).</p>
            <p>Enter a prompt like 'Stability vs. Change at maturity level 3' to see a graph of how poles interact at different maturity levels.</p>
            <p>Inspired by Barry Johnson's Polarity Management and models like CMMI.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Theme toggle
    function toggleTheme() {
      var body = document.body;
      body.classList.toggle('dark');
      body.classList.toggle('light');
      localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
      if (window.network) {
        window.network.setOptions({ nodes: { font: { color: body.classList.contains('dark') ? '#ffffff' : '#000000' } } });
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark');
        document.getElementById('themeToggle').checked = true;
      } else {
        document.body.classList.add('light');
      }
    });

    // Load example
    function loadExample() {
      var select = document.getElementById('example-select');
      var prompt = document.getElementById('prompt');
      prompt.value = select.value;
    }

    // Form submission
    document.getElementById('prompt-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var prompt = document.getElementById('prompt').value;
      if (!prompt.trim()) {
        document.getElementById('alert-placeholder').innerHTML =
          '<div class="alert alert-warning alert-dismissible fade show" role="alert">' +
          'Please enter a polarity prompt.' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
        return;
      }
      document.getElementById('spinner').style.display = 'block';
      fetch('/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: prompt })
      })
      .then(response => {
        if (!response.ok) throw new Error('Invalid input');
        return response.json();
      })
      .then(data => {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('alert-placeholder').innerHTML =
          '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
          'Graph generated successfully!' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
        var nodes = new vis.DataSet(data.nodes);
        var edges = new vis.DataSet(data.edges);
        var container = document.getElementById('network');
        window.network = new vis.Network(container, { nodes: nodes, edges: edges }, {
          nodes: { font: { color: document.body.classList.contains('dark') ? '#ffffff' : '#000000' } }
        });
      })
      .catch(error => {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('alert-placeholder').innerHTML =
          '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
          'Error generating graph. Please try again.' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
      });
    });

    // Reset form
    function resetForm() {
      fetch('/reset', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          document.getElementById('prompt').value = '';
          document.getElementById('example-select').value = '';
          document.getElementById('network').innerHTML = '';
          document.getElementById('alert-placeholder').innerHTML =
            '<div class="alert alert-info alert-dismissible fade show" role="alert">' +
            'Form and graph reset.' +
            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
        });
    }

    // Download graph
    function downloadGraph() {
      var network = document.getElementById('network').querySelector('canvas');
      if (network) {
        var link = document.createElement('a');
        link.download = 'polarity_maturity_graph.png';
        link.href = network.toDataURL('image/png');
        link.click();
      } else {
        document.getElementById('alert-placeholder').innerHTML =
          '<div class="alert alert-warning alert-dismissible fade show" role="alert">' +
          'No graph to download. Generate a graph first.' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
      }
    }
  </script>
</body>
</html>