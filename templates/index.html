<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polarity & Maturity Model</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.css" rel="stylesheet">
  <style>
    body.light { background-color: #ffffff; color: #000000; }
    body.dark { background-color: #1e1e1e; color: #ffffff; }
    .dark #network { background-color: #2c2c2c; }
    #network { width: 100%; height: 600px; border: 1px solid #ccc; }
    #spinner { display: none; text-align: center; padding: 20px; }
  </style>
</head>
<body class="light">
  <div class="container mt-4">
    <h1>Polarity & Maturity Model</h1>
    <!-- Theme Toggle -->
    <div class="form-check form-switch mb-3">
      <input class="form-check-input" type="checkbox" id="themeToggle" onchange="toggleTheme()">
      <label class="form-check-label" for="themeToggle">Dark Mode</label>
    </div>
    <!-- Form -->
    <form id="prompt-form">
      <div class="mb-3">
        <label for="example-select" class="form-label">Load Example</label>
        <select class="form-select" id="example-select" onchange="loadExample()">
          <option value="">Select an example</option>
          <option value="Stability vs. Change">Stability vs. Change</option>
          <option value="Individual vs. Team">Individual vs. Team</option>
          <option value="Centralization vs. Decentralization">Centralization vs. Decentralization</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="pole1-name" class="form-label">Pole 1 Name</label>
        <input type="text" class="form-control" id="pole1-name" placeholder="e.g., Stability"
          data-bs-toggle="tooltip" data-bs-placement="top" title="Name of the first pole in the dilemma.">
      </div>
      <div class="mb-3">
        <label for="pole1-maturity" class="form-label">Pole 1 Maturity (1-5)</label>
        <input type="number" class="form-control" id="pole1-maturity" min="1" max="5" value="3"
          data-bs-toggle="tooltip" data-bs-placement="top" title="Maturity level for Pole 1 (1: initial, 5: optimizing).">
      </div>
      <div class="mb-3">
        <label for="pole2-name" class="form-label">Pole 2 Name</label>
        <input type="text" class="form-control" id="pole2-name" placeholder="e.g., Change"
          data-bs-toggle="tooltip" data-bs-placement="top" title="Name of the second pole in the dilemma.">
      </div>
      <div class="mb-3">
        <label for="pole2-maturity" class="form-label">Pole 2 Maturity (1-5)</label>
        <input type="number" class="form-control" id="pole2-maturity" min="1" max="5" value="3"
          data-bs-toggle="tooltip" data-bs-placement="top" title="Maturity level for Pole 2 (1: initial, 5: optimizing).">
      </div>
      <div class="mb-3">
        <label for="polarity-weight" class="form-label">Polarity Weight (-1.0 shadow to 1.0 light)</label>
        <input type="number" class="form-control" id="polarity-weight" min="-1.0" max="1.0" step="0.1" value="0.5"
          data-bs-toggle="tooltip" data-bs-placement="top" title="Weight of polarity (-1.0: shadow/manipulative, 1.0: light/consensual).">
      </div>
      <div class="mb-3">
        <label for="consent" class="form-label">Consent (0 or 1)</label>
        <input type="number" class="form-control" id="consent" min="0" max="1" value="0"
          data-bs-toggle="tooltip" data-bs-placement="top" title="0 for no consent, 1 for full consent in the relationship.">
      </div>
      <div class="mb-3">
        <label for="metacognition" class="form-label">Metacognition (0 or 1)</label>
        <input type="number" class="form-control" id="metacognition" min="0" max="1" value="0"
          data-bs-toggle="tooltip" data-bs-placement="top" title="0 for no metacognition, 1 for awareness of ego states and dynamics.">
      </div>
      <button type="submit" class="btn btn-primary">Generate Graph</button>
      <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
      <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#helpModal">Help</button>
      <button type="button" class="btn btn-primary" onclick="downloadGraph()">Download Graph</button>
    </form>
    <!-- Alert Placeholder -->
    <div id="alert-placeholder" class="mt-3"></div>
    <!-- Spinner -->
    <div id="spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <!-- Graph Container -->
    <div id="network"></div>
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="helpModalLabel">About Polarity & Maturity Model</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>This app visualizes polarities (ongoing dilemmas like 'Individual vs. Team') across maturity stages (1: Initial, 5: Optimizing).</p>
            <p>Enter pole names, maturity levels, and polarity weights to see a graph of their interactions, with ego states and role flips.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Theme toggle
    function toggleTheme() {
      var body = document.body;
      body.classList.toggle('dark');
      body.classList.toggle('light');
      localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
      if (window.network) {
        window.network.setOptions({ nodes: { font: { color: body.classList.contains('dark') ? '#ffffff' : '#000000' } } });
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark');
        document.getElementById('themeToggle').checked = true;
      } else {
        document.body.classList.add('light');
      }
    });

    // Load example
    function loadExample() {
      var select = document.getElementById('example-select');
      var pole1Name = document.getElementById('pole1-name');
      var pole2Name = document.getElementById('pole2-name');
      var pole1Maturity = document.getElementById('pole1-maturity');
      var pole2Maturity = document.getElementById('pole2-maturity');
      var polarityWeight = document.getElementById('polarity-weight');
      var consent = document.getElementById('consent');
      var metacognition = document.getElementById('metacognition');
      if (select.value === 'Stability vs. Change') {
        pole1Name.value = 'Stability';
        pole2Name.value = 'Change';
        pole1Maturity.value = 2;
        pole2Maturity.value = 2;
        polarityWeight.value = 0.5;
        consent.value = 0;
        metacognition.value = 0;
      } else if (select.value === 'Individual vs. Team') {
        pole1Name.value = 'Individual';
        pole2Name.value = 'Team';
        pole1Maturity.value = 4;
        pole2Maturity.value = 4;
        polarityWeight.value = 0.8;
        consent.value = 1;
        metacognition.value = 1;
      } else if (select.value === 'Centralization vs. Decentralization') {
        pole1Name.value = 'Centralization';
        pole2Name.value = 'Decentralization';
        pole1Maturity.value = 3;
        pole2Maturity.value = 3;
        polarityWeight.value = 0.5;
        consent.value = 0;
        metacognition.value = 0;
      } else {
        pole1Name.value = '';
        pole2Name.value = '';
        pole1Maturity.value = 3;
        pole2Maturity.value = 3;
        polarityWeight.value = 0.5;
        consent.value = 0;
        metacognition.value = 0;
      }
      updateGraph(); // Auto-update graph on example load
    }

    // Update graph dynamically
    function updateGraph() {
      var pole1Name = document.getElementById('pole1-name').value;
      var pole2Name = document.getElementById('pole2-name').value;
      var pole1Maturity = parseInt(document.getElementById('pole1-maturity').value);
      var pole2Maturity = parseInt(document.getElementById('pole2-maturity').value);
      var polarityWeight = parseFloat(document.getElementById('polarity-weight').value);
      var consent = parseInt(document.getElementById('consent').value);
      var metacognition = parseInt(document.getElementById('metacognition').value);
      if (!pole1Name.trim() || !pole2Name.trim()) {
        document.getElementById('alert-placeholder').innerHTML =
          '<div class="alert alert-warning alert-dismissible fade show" role="alert">' +
          'Please enter both pole names.' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
        return;
      }
      document.getElementById('spinner').style.display = 'block';
      fetch('/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: `${pole1Name} vs. ${pole2Name}`,
          pole1Name: pole1Name,
          pole2Name: pole2Name,
          pole1Maturity: pole1Maturity,
          pole2Maturity: pole2Maturity,
          polarityWeight: polarityWeight,
          consent: consent,
          metacognition: metacognition
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(errData => { throw errData; });
        }
        return response.json();
      })
      .then(data => {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('alert-placeholder').innerHTML =
          '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
          'Graph generated successfully!' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
        var nodes = new vis.DataSet(data.nodes.map(node => ({
          ...node,
          size: node.maturity * 20,
          color: {
            background: `hsl(${node.maturity * 24}, 100%, 50%)`, // Red (1) to green (5)
            border: '#000000'
          }
        })));
        var edges = new vis.DataSet(data.edges.map(edge => ({
          ...edge,
          width: Math.abs(edge.polarity) * 5,
          color: edge.polarity >= 0 ? 'green' : 'red',
          label: edge.polarity.toFixed(2) // Show polarity weight
        })));
        var container = document.getElementById('network');
        window.network = new vis.Network(container, { nodes: nodes, edges: edges }, {
          nodes: { font: { color: document.body.classList.contains('dark') ? '#ffffff' : '#000000' } },
          edges: { font: { align: 'middle' } }
        });
      })
      .catch(error => {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('alert-placeholder').innerHTML =
          '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
          `Error generating graph: ${error.error || error.message || 'Unknown error'}` +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
      });
    }

    // Form submission
    document.getElementById('prompt-form').addEventListener('submit', function(e) {
      e.preventDefault();
      updateGraph();
    });

    // Reset form
    function resetForm() {
      fetch('/reset', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          document.getElementById('pole1-name').value = '';
          document.getElementById('pole2-name').value = '';
          document.getElementById('example-select').value = '';
          document.getElementById('pole1-maturity').value = 3;
          document.getElementById('pole2-maturity').value = 3;
          document.getElementById('polarity-weight').value = 0.5;
          document.getElementById('consent').value = 0;
          document.getElementById('metacognition').value = 0;
          document.getElementById('network').innerHTML = '';
          document.getElementById('alert-placeholder').innerHTML =
            '<div class="alert alert-info alert-dismissible fade show" role="alert">' +
            'Form and graph reset.' +
            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
        });
    }

    // Download graph
    function downloadGraph() {
      var network = document.getElementById('network').querySelector('canvas');
      if (network) {
        var link = document.createElement('a');
        link.download = 'polarity_maturity_graph.png';
        link.href = network.toDataURL('image/png');
        link.click();
      } else {
        document.getElementById('alert-placeholder').innerHTML =
          '<div class="alert alert-warning alert-dismissible fade show" role="alert">' +
          'No graph to download. Generate a graph first.' +
          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
      }
    }
  </script>
</body>
</html>